# 小麻雀内核手册

## 1 概览
小麻雀内核是基于标准RISC-V指令集架构开发的32位通用MCU级处理器内核；采用2级流水线设计，大部分指令都为单周期；哈佛结构，采用ICB总线接口，最大支持4GB线性地址空间；支持参数化配置内核的各项指标；支持JTAG调试接口与部分调试功能。
### 1.1 关键特性
|项目|描述|
|-|-|
|指令集|RV32 I/E [M] Zicsr|
|流水线|2级|
|总线接口|ICB|
|总线阻塞|支持|
|程序存储器|核内，大小可配置|
|中断系统|向量中断|
|特权等级|仅M机器模式|
|C语言编程|支持|
|FPGA综合|支持|

### 1.2 指令集
小麻雀内核支持RV32 I/E \[M\] Zicsr指令集组合，可根据需求灵活配置。其中，`I`和`E`代表通用寄存器个数，必须二选一；`M`扩展是可选项。  
- RV32：32位RV架构，通用寄存器位宽为32位
- I：支持基本整数指令，具有32个整数通用寄存器
- E：支持基本整数指令，具有16个整数通用寄存器
- M：支持整数乘法指令和整数除法指令
- Zicsr：支持CSR空间和CSR指令

小麻雀内核对每条指令的处理方式符合RISC-V指令集架构的规范。在硬件实现层面上，大部分为单周期指令，`ld`总线读指令和除法指令是多周期指令。  
|指令|功能|周期数|
|---|---|---|
||基本运算||
|add|rd=rs1+rs2 |1|
|sub|rd=rs1-rs2 |1|
|xor|rd=rs1^rs2 |1|
|or |rd=rs1\|rs2 |1|
|and|rd=rs1&rs2 |1|
|sll|rd=rs1<<rs2|1|
|srl|rd=rs1>>rs2|1|
|sra|rd=rs1>>rs2 高位扩展|1|
|slt|rd=(rs1<rs2)?1:0|1|
|sltu|(rd=rs1<rs2)?1:0 0扩展|1|
||带立即数运算||
|addi|rd=rs1+imm|1|
|xori|rd=rs1^imm |1|
|ori |rd=rs1\|imm |1|
|andi|rd=rs1&imm |1|
|slli|rd=rs1<<imm[0:4]|1|
|srli|rd=rs1>>imm[0:4]|1|
|srai|rd=rs1>>imm[0:4] 高位扩展|1|
|slti|rd=(rs1<imm)?1:0|1|
|sltiu|rd=(rs1<imm)?1:0 0扩展|1|
||读总线||
|lb|rd=M[rs1+imm][0: 7]|2|
|lh|rd=M[rs1+imm][0:15]|2|
|lw|rd=M[rs1+imm][0:31]|2|
|lbu|rd=M[rs1+imm][0:7] 0扩展|2|
|lhu|rd=M[rs1+imm][0:15] 0扩展|2|
||写总线||
|sb|M[rs1+imm][0: 7]=rs2[0: 7]|1|
|sh|M[rs1+imm][0:15]=rs2[0:15]|1|
|sw|M[rs1+imm][0:31]=rs2[0:31]|1|
||条件分支||
|beq|if(rs1==rs2) PC+=imm|1|
|bne|if(rs1!=rs2) PC+=imm|1|
|blt|if(rs1<rs2) PC+=imm|1|
|bge|if(rs1>=rs2) PC+=imm|1|
|bltu|if(rs1<rs2) PC+=imm 0扩展|1|
|bgeu|if(rs1>=rs2) PC+=imm 0扩展|1|
||跳转指令||
|jal|rd=PC+4; PC+=imm|1|
|jalr|rd=PC+4; PC=rs1+imm|1|
||装载立即数||
|lui|rd=imm<<12|1|
|auipc|PC+(rd=imm<<12)|1|
||中断相关||
|mret|中断返回|1|
|wfi|休眠等待中断唤醒|1|
||CSR相关||
|csrrw|CSR[imm]=rs1|1|
|csrrs|CSR[imm]=rs1\|CSR[imm]|1|
|csrrc|CSR[imm]=~rs1&CSR[imm]|1|
|csrrwi|CSR[imm]=zimm|1|
|csrrsi|CSR[imm]=zimm\|CSR[imm]|1|
|csrrci|CSR[imm]=~zimm&CSR[imm]|1|
||M扩展||
|mul|rd=rs1*rs2[0:31]|1|
|mulhu|无符号rd=rs1*rs2[32:63]|1|
|mulh|有符号rd=rs1*rs2[32:63]|1|
|mulsu|rd=有符号rs1*无符号rs2[32:63]|1|
|div|有符号rd=rs1/rs2|2-33|
|divu|无符号rd=rs1/rs2|2-33|
|rem|有符号rd=rs1%rs2|2-33|
|remu|无符号rd=rs1%rs2|2-33|


### 1.3 寄存器组GPR
RV32寄存器组的数据宽度都为32位，RV32I拥有x0-x31共32个寄存器组，RV32E拥有x0-x15共16个寄存器组。  
|寄存器|ABI名称|功能|储存者|
|-|-|-|-|
|x0|zero|硬编码0|-|
|x1|ra|返回地址|Caller|
|x2|sp|栈指针|Callee|
|x3|gp|全局指针|-|
|x4|tp|线程指针|-|
|x5-7|t0-2|临时寄存器|Caller|
|x8|s0/fp|保存寄存器/帧指针|Callee|
|x9|s1|保存寄存器|Callee|
|x10-11|a0-1|函数参数/返回值|Caller|
|x12-17|a2-7|函数参数|Caller|
|x18-27|s2-11|保存寄存器|Callee|
|x28-31|t3-6|临时寄存器|Caller|

Caller是被调过程不保存该寄存器值，Callee是被调过程保存该寄存器。   

### 1.4 特权模式
RISC-V包含了多种特权模式，小麻雀内核仅支持机器模式。机器模式具有最高的权限，该模式下程序可以访问所有的控制和状态寄存器(Control and
Status Register,CSR)，同时也能够访问除物理内存保护单元锁定之外的所有的物理地址区域。    

## 2 功能框架
### 2.1 结构框图
小麻雀内核的结构如图所示：  
![内核原理图](/doc/图库/数据手册/内核原理图.svg)  

### 2.2 内核端口


### 2.3 程序存储器
程序存储器对应源文件`iram.v`，是一个真双端口的同步存储器。由于小麻雀内核的特性，取指操作不允许阻塞，因此需要使用同步SRAM作为程序存储器。  
程序存储器的一个端口只读，作为取指端口，每周期可以取出一条指令。  
程序存储器的另一个端口可读可写，并以ICB Slave的形式引出到内核顶层端口。  



## 3 中断和异常
在小麻雀处理器中，发生中断或异常后处理器进入陷阱(trap)，处理硬件错误、指令错误、中断请求等事务。就像走路踩陷阱一样难以预测，并且立即脱离正常状态。，其来源既包含了定时器、串口等外设产生的中断，也包含了指令错误等内部发生的异常。  
