# 软件开发手册
在此之前，必须安装MRS  

## bsp_app
面向完整的应用程序，包含了启动文件、链接脚本、外设驱动、常用例程。  
如果编译使用SD卡加载的程序，由于起始地址发生改变，需要将`/bsp/bsp_app/link.lds`的`_use_sd_iap`改为1  

## bsp_iap
面向在应用编程(In Application Programming, IAP)程序的BSP，功能是从SD卡加载程序，搬移至iram的相应空间。驱动程序经过大幅度裁剪，以保证占用空间尽可能小。  
`/bsp/SparrowRV_IAP.bin`是编译好的IAP程序，可通过`tb/工具箱.bat`转换为`inst.txt`后随着RTL一起综合并写进FPGA  

## OpenOCD
用于JTAG调试，支持`DAPLink v1/v2` `CH347`，`CH347`稍微有点问题。  

## 从SD卡启动程序
小麻雀处理器可以将程序和RTL设计一起烧进FPGA，但是这种操作意味着每次程序修改后都需要重新进行逻辑综合，需要消耗大量的时间。为了提升程序开发效率，小麻雀处理器配备了IAP程序，可以从SD卡完成启动。为了保证功能正常，SD卡必须格式化为FAT32且采用MBR分区表，根目录有且只能有一个`SparrowRV_APP.bin`文件。为了保证最佳兼容性，即使根目录没有文件也最好重新格式化一次，然后把`SparrowRV_APP.bin`文件放进来。  
IAP占据了程序存储器的低1024字节，地址范围是0x0000-0x03FF，需要和RTL设计一起烧进FPGA，作为固化在设计中的程序，不可修改。FPGA上电后，首先从IAP程序启动，读取SD卡的第一个分区的第一个文件，将其内容填充到程序存储器的1024字节以上区域，即高于0x0400的地址。  
由于小麻雀处理器的SD卡读取操作使用SDIO总线，而不是SPI，因此兼容性极佳，就`SD/TF卡`本身而言几乎不存在兼容性问题，任意容量的都能支持。在文件系统方面，要求SD卡采用MBR分区表，有且只有1个FAT32分区，根目录只有1个文件，这是硬性的要求，必须满足。  
